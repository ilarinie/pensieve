name: Claude PR Review
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          prompt: |
            Review this PR against the project rules in CLAUDE.md.
            Focus on:
            - Functional style (no classes)
            - Proper dependency injection (db as first param, no singletons)
            - TSDoc on every export
            - Test coverage (co-located tests, vitest, describe/test not it)
            - Security (OWASP top 10)
            - No semicolons, single quotes
            - Import extensions (.js on relative imports)
            - const + arrow for exports
            - type not interface
            - kebab-case file names

            Documentation check:
            - Read docs/wiki/*.md files and their frontmatter `sources:` lists
            - If any file in the PR diff appears in a doc page's `sources:`, flag that
              the documentation may need updating and name the specific wiki page(s)
            - If new service files, handlers, or significant features are added
              (e.g. new files in packages/server/src/services/ or packages/server/src/handlers/)
              and no docs/wiki/ page lists them in its sources, suggest creating documentation

            Post inline comments for specific issues.
            Approve if the PR follows all rules, request changes otherwise.
